<div class="adherents-container">
  <h2 class="title">Liste des Adhérents</h2>
</div>

<div class="fil-cherch">
  <div class="search-wrapper">
    <i class="pi pi-search search-icon"></i>
    <input type="text" placeholder="Rechercher..." class="search-input" (input)="onGlobalSearch($event)" />
  </div>
</div>


<p-table #dt [value]="adherents" [paginator]="true" [rows]="5" [rowsPerPageOptions]="[5, 10, 15]"
  [globalFilterFields]="['nom', 'prenom', 'tel']" [responsiveLayout]="'scroll'" [loading]="loading">
  <ng-template pTemplate="header">
    <tr>
      <th>#</th>
      <th>Nom et Prénom</th>
      <th>CIN</th>
      <!-- <th>Téléphone</th> -->
      <th>Email</th>
      <th>État</th>
      <th>Montant</th>
      <th>Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-adherent let-i="rowIndex">
    <tr>
      <td>{{ i + 1 }}</td>
      <td (click)="showDetails(adherent)">
        <img 
  [src]="adherent.photoProfilBase64 ? 'data:image/jpeg;base64,' + adherent.photoProfilBase64 : getDefaultAvatar(adherent.sexe)" 
  class="avatar" />

        {{ adherent.nom }} {{ adherent.prenom }}
      </td>
      <td>{{ adherent.cin }}</td>
      <!-- <td>{{ adherent.tel }}</td> -->
      <td>{{ adherent.email }}</td>
      <td>{{ adherent.etat }}</td>
      <td>{{ adherent.montant }} DT</td>
      <td class="dropdown-wrapper">
        <div class="dropdown">
          <button class="lib-button" (click)="toggleDropdown(adherent)">
            Actions <i class="fas fa-chevron-down"></i>
          </button>
      
          <div class="lib-dropdown" *ngIf="dropdownVisibleForCin === adherent.cin" [ngClass]="{ 'open-up': i  >= adherents.length - 2 }">
            <button class="lib-menu-item text-danger" (click)="desactiver(adherent)">
              <i class="fas fa-user-slash"></i> Désactiver
            </button>
            <button class="lib-menu-item text-warning" (click)="suspendre(adherent)">
              <i class="fas fa-ban"></i> Suspendre
            </button>
            
          </div>
        </div>
      </td>
      
      
      
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="8">Aucun adhérent trouvé.</td>
    </tr>
  </ng-template>
</p-table>

<!-- ✅ POPUP DETAILS -->
<div class="popup-overlay" *ngIf="selectedAdherent" (click)="closePopup()">
  <div class="popup-card" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closePopup()">✖</button>
    <div class="profile-header">
      <img [src]="selectedAdherent.photo" class="popup-avatar" />
      <h3 class="user-name">{{ selectedAdherent.nom }} {{ selectedAdherent.prenom }}</h3>
    </div>
    <div class="detail-item"><i class="fa-solid fa-id-card icon-vert"></i>{{ selectedAdherent.cin }}</div>
    <div class="detail-item"><i class="fa-solid fa-envelope icon-vert"></i>{{ selectedAdherent.email }}</div>
    <div class="detail-item"><i class="fa-solid fa-phone icon-vert"></i>{{ selectedAdherent.tel }}</div>
    <div class="detail-item"><i class="fa-solid fa-coins icon-vert"></i>Montant : {{ selectedAdherent.montant }} DT</div>
    <div class="detail-item"><i class="fa-solid fa-calendar-days icon-vert"></i>Adhésion : {{ selectedAdherent.dateAdhesion | date: 'dd/MM/yyyy' }}</div>
    <!-- <div class="detail-item"><i class="fa-solid fa-calendar-xmark icon-vert"></i>Fin : {{ selectedAdherent.dateFin | date: 'dd/MM/yyyy' }}</div> -->
    <div class="detail-item"><i class="fa-solid fa-circle-info icon-vert"></i>Statut : {{ selectedAdherent.etat }}</div>
    <div class="detail-item" *ngIf="bilan">
      <i class="fa-solid fa-coins icon-vert"></i>
      Total versé : {{ bilan.montantTotalVerse }} DT
    </div>
    
    <div class="detail-item" *ngIf="bilan">
      <i class="fa-solid fa-layer-group icon-vert"></i>
      Actions : {{ bilan.nombreTotalActions }}
    </div>
    
    <div class="detail-item" *ngIf="bilan">
      <i class="fa-solid fa-hourglass-half icon-vert"></i>
      Reste à payer : {{ bilan.montantRestant }} DT
    </div>

    <!-- ✅ État d'adhésion -->
<div class="detail-item" *ngIf="bilan">
  <i class="fa-solid fa-shield-check icon-vert"></i>
  <span [ngClass]="bilan.adhesionComplete ? 'text-success' : 'text-danger'">
    {{ bilan.adhesionComplete ? 'Adhésion Complète ✅' : 'Adhésion Incomplète ❌' }}
  </span>
</div>

    
    <div class="detail-item" *ngIf="bilan?.dateDernierVersement">
      <i class="fa-solid fa-calendar-check icon-vert"></i>
      Dernier paiement : {{ bilan?.dateDernierVersement| date:'dd/MM/yyyy' }}
    </div>
    

  </div>
</div>
